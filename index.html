const SHEET_ID = "1ZWboG5p4FRklcABlLhX7SomEb8gDhYzrPsuvfJQ_OxQ"; // 你實際的試算表 ID
const SHEET_NAME = "Sheet1"; // 如有不同請修改

function doGet(e) {
  const action = e?.parameter?.action;
  if (action === "update") return doUpdate(e);
  if (action === "toggle") return doToggle(e);
  return ContentService.createTextOutput(JSON.stringify(getData()))
    .setMimeType(ContentService.MimeType.JSON);
}

function getData() {
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  return { rows: data.slice(2) }; // 跳過前兩列：標題列與篩選列
}

function doUpdate(e) {
  const row = parseInt(e.parameter.row, 10) + 3; // 加 3 ➜ Google Sheet 第 4 列起算資料
  const col = parseInt(e.parameter.col, 10) + 1;
  const val = e.parameter.val;
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
  sheet.getRange(row, col).setValue(val);
  sheet.getRange(row, 9).setValue(nowHK()); // ✅ 僅寫入時間（I 欄）
  return ContentService.createTextOutput("OK");
}

function doToggle(e) {
  const row = parseInt(e.parameter.row, 10) + 3;
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
  const cell = sheet.getRange(row, 8); // H 欄為 Status
  const current = (cell.getValue() || "").toString().toLowerCase();
  const next = current === "completed" ? "Pending" : "Completed";
  cell.setValue(next);
  sheet.getRange(row, 9).setValue(nowHK()); // ✅ 寫入時間（I 欄）
  return ContentService.createTextOutput("OK");
}

function nowHK() {
  return Utilities.formatDate(new Date(), "Asia/Hong_Kong", "yyyy/MM/dd, HH:mm:ss");
}
